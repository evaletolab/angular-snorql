"use strict";angular.module("snorql.config",[]).factory("config",[function(){var e={owl:"http://www.w3.org/2002/07/owl#",xsd:"http://www.w3.org/2001/XMLSchema#",rdfs:"http://www.w3.org/2000/01/rdf-schema#",rdf:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",foaf:"http://xmlns.com/foaf/0.1/",geo:"http://www.w3.org/2003/01/geo/wgs84_pos#",dc:"http://purl.org/dc/elements/1.1/","":"http://dbpedia.org/resource/",dbpedia2:"http://dbpedia.org/property/",dbpedia:"http://dbpedia.org/",skos:"http://www.w3.org/2004/02/skos/core#",category:"http://dbpedia.org/resource/Category:",dcterms:"http://purl.org/dc/terms/",ontology:"http://dbpedia.org/ontology/",virtuoso:"http://www.openlinksw.com/virtrdf-data-formats"},t={home:"https://github.com/evaletolab/angular-snorql",sparql:{endpoint:"http://dbpedia.org/sparql",examples:"queries.json",prefixes:e}};return t}]),angular.module("snorql.ui",[]).directive("menuToggle",[function(){function e(e,t){t.click(function(){$(".row-offcanvas").toggleClass("active")})}return{link:e}}]).directive("sparqlFormatter",["snorql",function(e){function t(t,n){t.$watch("sparqlFormatter",function(t){t&&(r=e.SPARQLResultFormatter(),n.html(r.toDOM()))})}var r;return{restrict:"A",scope:{sparqlFormatter:"="},link:t}}]),angular.module("snorql.service",[]).factory("snorql",["$http","$q","$timeout","$location","config",function(e,t,r,n,a){var o={property:"SELECT DISTINCT ?resource ?value\nWHERE { ?resource <URI_COMPONENT> ?value }\nORDER BY ?resource ?value",clazz:"SELECT DISTINCT ?instance\nWHERE { ?instance a <URI_COMPONENT> }\nORDER BY ?instance",describe:"SELECT DISTINCT ?property ?hasValue ?isValueOf\nWHERE {\n  { <URI_COMPONENT> ?property ?hasValue }\n  UNION\n  { ?isValueOf ?property <URI_COMPONENT> }\n}\nORDER BY (!BOUND(?hasValue)) ?property ?hasValue ?isValueOf",query:"SELECT DISTINCT * WHERE {\n  ?s ?p ?o\n}\nLIMIT 10",sparqlEndpoint:a.sparql.endpoint,sparqlUrlExamples:a.sparql.examples},s={"default-graph-uri":null,"named-graph-uri":null,output:"json"},i={html:"application/sparql-results+json,*/*",json:"application/sparql-results+json,*/*",xml:"application/sparql-results+xml,*/*",csv:"application/sparql-results+csv,*/*"},l=function(){var e="";for(var t in a.sparql.prefixes){var r=a.sparql.prefixes[t];e=e+"PREFIX "+t+": <"+r+">\n"}return e},u=function(){this.examples=[],this.tags=[],this.result={head:[],results:[]},this.query=o.query,this.examplesUrl=o.sparqlUrlExamples,this.$promise=t.when(this),this.canceler=t.defer()};return u.prototype.reset=function(){this.canceler.resolve(),this.result={head:[],results:[]},this.canceler=t.defer()},u.prototype.endpoint=function(){return o.sparqlEndpoint},u.prototype.loadExamples=function(){var t=this;return this.examples.length?this:(this.$promise=this.$promise.then(function(){return e({method:"GET",url:t.examplesUrl})}),this.$promise.then(function(e){var r=0;t.examples=e.data,t.examples.forEach(function(e){e.index=r++,e.tags&&e.tags.split(",").forEach(function(e){-1==t.tags.indexOf(e.trim())&&t.tags.push(e)})})}),this)},u.prototype.updateQuery=function(e){return this.query=e.class?o.clazz.replace(/URI_COMPONENT/g,e.class):e.property?o.property.replace(/URI_COMPONENT/g,e.property):e.describe?o.describe.replace(/URI_COMPONENT/g,e.describe):e.query||o.query,this.query},u.prototype.executeQuery=function(n,a){var u=this;if(!n||""===n)return u;this.reset();var c=angular.extend(s,a,{query:n});c.query=l()+"\n"+c.query;var p={Accept:i[c.output]},d=o.sparqlEndpoint;if("html"!==c.output){u.reset();var h=t.defer();return window.location=d+"?"+$.param(c),this.$promise=h.promise,r(function(){h.resolve(this)},200),u}return c.output="json",this.$promise=e({method:"GET",url:d,params:c,headers:p,timeout:this.canceler.promise}),this.$promise.then(function(e){u.result=e.data,console.log(u.result)}),this},u.prototype.prefixes=function(){return a.sparql.prefixes},u.prototype.SPARQLResultFormatter=function(){return new function(e,t){this._json=e,this._variables=this._json.head.vars||{},this._results=this._json.results.bindings||[],this._namespaces=t,this.toDOM=function(){var e=document.createElement("table");e.className="queryresults",e.appendChild(this._createTableHeader());for(var t=0;t<this._results.length;t++)e.appendChild(this._createTableRow(this._results[t],t));return e},this._getLinkMaker=function(e){return"property"==e?function(e){return"?property="+encodeURIComponent(e)}:"class"==e?function(e){return"?class="+encodeURIComponent(e)}:function(e){return"?describe="+encodeURIComponent(e)}},this._createTableHeader=function(){for(var e=document.createElement("tr"),t=!1,r=0;r<this._variables.length;r++){var n=document.createElement("th");n.appendChild(document.createTextNode(this._variables[r])),e.appendChild(n),"namedgraph"==this._variables[r]&&(t=!0)}if(t){var n=document.createElement("th");n.appendChild(document.createTextNode(" ")),e.insertBefore(n,e.firstChild)}return e},this._createTableRow=function(e,t){var r=document.createElement("tr");r.className=t%2?"odd":"even";for(var n=null,a=0;a<this._variables.length;a++){var o=this._variables[a];i=document.createElement("td"),i.appendChild(this._formatNode(e[o],o)),r.appendChild(i),"namedgraph"==this._variables[a]&&(n=e[o])}if(n){var s=document.createElement("a");s.href="javascript:snorql.switchToGraph('"+n.value+"')",s.appendChild(document.createTextNode("Switch"));var i=document.createElement("td");i.appendChild(s),r.insertBefore(i,r.firstChild)}return r},this._formatNode=function(e,t){return e?"uri"==e.type?this._formatURI(e,t):"bnode"==e.type?this._formatBlankNode(e,t):"literal"==e.type?this._formatPlainLiteral(e,t):"typed-literal"==e.type?this._formatTypedLiteral(e,t):document.createTextNode("???"):this._formatUnbound(e,t)},this._formatURI=function(e,t){var r=document.createElement("span");r.className="uri";var n=document.createElement("a");n.href=this._getLinkMaker(t)(e.value),n.title="<"+e.value+">",n.className="graph-link";var a=this._toQName(e.value);a?(n.appendChild(document.createTextNode(a)),r.appendChild(n)):(o=e.value.match(/\.(png|gif|jpg)(\?.+)?$/),o?(i=document.createElement("img"),i.src=e.value,i.title=e.value,i.className="media",n.appendChild(i),r.appendChild(n)):(n.appendChild(document.createTextNode(e.value)),r.appendChild(document.createTextNode("<")),r.appendChild(n),r.appendChild(document.createTextNode(">"))));var o=e.value.match(/^(https?|ftp|mailto|irc|gopher|news):/);if(o){r.appendChild(document.createTextNode(" "));var s=document.createElement("a");s.href=e.value;var i=document.createElement("img");i.src="img/link.png",i.alt="["+o[1]+"]",i.title="Go to Web page",s.appendChild(i),r.appendChild(s)}return r},this._formatPlainLiteral=function(e){var t='"'+e.value+'"';return e["xml:lang"]&&(t+="@"+e["xml:lang"]),document.createTextNode(t)},this._formatTypedLiteral=function(e){var t='"'+e.value+'"';if(e.datatype&&(t+="^^"+this._toQNameOrURI(e.datatype)),this._isNumericXSDType(e.datatype)){var r=document.createElement("span");return r.title=t,r.appendChild(document.createTextNode(e.value)),r}return document.createTextNode(t)},this._formatBlankNode=function(e){return document.createTextNode("_:"+e.value)},this._formatUnbound=function(){var e=document.createElement("span");return e.className="unbound",e.title="Unbound",e.appendChild(document.createTextNode("-")),e},this._toQName=function(e){for(var t in this._namespaces){var r=this._namespaces[t];if(0==e.indexOf(r))return t+":"+e.substring(r.length)}return null},this._toQNameOrURI=function(e){var t=this._toQName(e);return null==t?"<"+e+">":t},this._isNumericXSDType=function(e){for(var t=0;t<this._numericXSDTypes.length;t++)if(e==this._xsdNamespace+this._numericXSDTypes[t])return!0;return!1},this._xsdNamespace="http://www.w3.org/2001/XMLSchema#",this._numericXSDTypes=["long","decimal","float","double","int","short","byte","integer","nonPositiveInteger","negativeInteger","nonNegativeInteger","positiveInteger","unsignedLong","unsignedInt","unsignedShort","unsignedByte"]}(this.result,this.prefixes())},new u}]);var app=angular.module("snorql",["ngRoute","ui.codemirror","snorql.config","snorql.service","snorql.ui"]);app.controller("SnorqlCtrl",["$scope","$timeout","$location","snorql","config",function(e,t,r,n,a){e.home=a.home,e.snorql=n,e.outputs=["html","json","csv","xml"],e.output="html",e.message="Excuting query ...",e.waiting=!1,e.filter="",e.cmOption={lineNumbers:!1,indentWithTabs:!0,uiRefresh:!0,mode:"sparql"},e.executeQuery=function(t){var a=Date.now();e.executionTime=!1,e.waiting=!0,e.error=!1,r.search("query",t),r.search("class",null),r.search("property",null),r.search("describe",null);var o=angular.extend(r.search(),{output:e.output});n.executeQuery(t,o).$promise.then(function(){e.waiting=!1,e.executionTime=(Date.now()-a)/1e3},function(t){e.error=t.data,e.waiting=!1})},e.selectExample=function(t){n.query=n.examples[t].query,e.qSelected=t,$(".row-offcanvas").removeClass("active")},e.reset=function(){n.reset()},n.loadExamples(),n.updateQuery(r.search()),e.$on("$locationChangeSuccess",function(){n.updateQuery(r.search())})}]),app.config(["$routeProvider","$locationProvider","$httpProvider",function(e,t,r){r.interceptors.push("errorInterceptor"),e.when("/",{title:"welcome to snorql",templateUrl:"partials/home.html"}),t.html5Mode(!0)}]),app.factory("errorInterceptor",["$q","$rootScope","$location",function(e,t){return{request:function(t){return t||e.when(t)},requestError:function(t){return e.reject(t)},response:function(t){return t||e.when(t)},responseError:function(r){return r&&0===r.status&&(t.error="The API is not accessible"),r&&401===r.status&&(t.error="You are not authorized to access the resource. Please login or review your privileges."),r&&404===r.status&&(t.error="URL not found"),r&&r.status>=500&&(t.error="Request Failed"),e.reject(r)}}}]);