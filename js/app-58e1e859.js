angular.module("snorql.ui",[]).directive("menuToggle",[function(){function e(e,t){t.click(function(){$(".row-offcanvas").toggleClass("active")})}return{link:e}}]).directive("sparqlFormatter",["snorql",function(e){function t(t,n){t.$watch("sparqlFormatter",function(t){t&&(r=e.SPARQLResultFormatter(),n.html(r.toDOM()))})}var r;return{restrict:"A",scope:{sparqlFormatter:"="},link:t}}]),angular.module("snorql.service",[]).factory("snorql",["$http","$q","$timeout","$location",function(e,t,r){var n={owl:"http://www.w3.org/2002/07/owl#",xsd:"http://www.w3.org/2001/XMLSchema#",rdfs:"http://www.w3.org/2000/01/rdf-schema#",rdf:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",foaf:"http://xmlns.com/foaf/0.1/",dc:"http://purl.org/dc/elements/1.1/","":"http://dbpedia.org/resource/",dbpedia2:"http://dbpedia.org/property/",dbpedia:"http://dbpedia.org/",skos:"http://www.w3.org/2004/02/skos/core#",category:"http://dbpedia.org/resource/Category:",dcterms:"http://purl.org/dc/terms/",ontology:"http://dbpedia.org/ontology/",virtuoso:"http://www.openlinksw.com/virtrdf-data-formats"},a={property:"SELECT DISTINCT ?resource ?value\nWHERE { ?resource <URI_COMPONENT> ?value }\nORDER BY ?resource ?value",clazz:"SELECT DISTINCT ?instance\nWHERE { ?instance a <URI_COMPONENT> }\nORDER BY ?instance",describe:"SELECT DISTINCT ?property ?hasValue ?isValueOf\nWHERE {\n  { <URI_COMPONENT> ?property ?hasValue }\n  UNION\n  { ?isValueOf ?property <URI_COMPONENT> }\n}\nORDER BY (!BOUND(?hasValue)) ?property ?hasValue ?isValueOf",query:"SELECT DISTINCT * WHERE {\n  ?s ?p ?o\n}\nLIMIT 10",sparqlEndpoint:"http://dbpedia.org/sparql",sparqlUrlExamples:"queries.json"},o={"default-graph-uri":null,"named-graph-uri":null,output:"json"},s={html:"application/sparql-results+json,*/*",json:"application/sparql-results+json,*/*",xml:"application/sparql-results+xml,*/*",csv:"application/sparql-results+csv,*/*"},u=function(){prefixes="";for(var e in n){var t=n[e];prefixes=prefixes+"PREFIX "+e+": <"+t+">\n"}return prefixes},l=function(){this.examples=[],this.tags=[],this.result={head:[],results:[]},this.query=a.query,this.examplesUrl=a.sparqlUrlExamples,this.$promise=t.when(this)};return l.prototype.reset=function(){this.result={head:[],results:[]}},l.prototype.endpoint=function(){return a.sparqlEndpoint},l.prototype.loadExamples=function(){var t=this;return this.examples.length?this:(this.$promise=this.$promise.then(function(){return e({method:"GET",url:t.examplesUrl})}),this.$promise.then(function(e){var r=0;t.examples=e.data,t.examples.forEach(function(e){e.index=r++,-1==t.tags.indexOf(e.tags)&&t.tags.push(e.tags)})}),this)},l.prototype.updateQuery=function(e){return this.query=e.class?a["class"].replace(/URI_COMPONENT/g,e.class):e.property?a.property.replace(/URI_COMPONENT/g,e.property):e.describe?a.describe.replace(/URI_COMPONENT/g,e.describe):e.query||a.query,this.query},l.prototype.executeQuery=function(n,i){var l=this;if(!n||""===n)return l;this.reset();var p=angular.extend(o,i,{query:n});p.query=u()+"\n"+p.query;var c={Accept:s[p.output]},d=a.sparqlEndpoint;if("html"!==p.output){l.reset();var h=t.defer();return window.location=d+"?"+$.param(p),this.$promise=h.promise,r(function(){h.resolve(this)},200),l}return p.output="json",this.$promise=e({method:"GET",url:d,params:p,headers:c}),this.$promise.then(function(e){l.result=e.data,console.log(l.result)}),this},l.prototype.prefixes=function(){return n},l.prototype.SPARQLResultFormatter=function(){return new function(e,t){this._json=e,this._variables=this._json.head.vars||{},this._results=this._json.results.bindings||[],this._namespaces=t,this.toDOM=function(){var e=document.createElement("table");e.className="queryresults",e.appendChild(this._createTableHeader());for(var t=0;t<this._results.length;t++)e.appendChild(this._createTableRow(this._results[t],t));return e},this._getLinkMaker=function(e){return"property"==e?function(e){return"?property="+encodeURIComponent(e)}:"class"==e?function(e){return"?class="+encodeURIComponent(e)}:function(e){return"/?describe="+encodeURIComponent(e)}},this._createTableHeader=function(){for(var e=document.createElement("tr"),t=!1,r=0;r<this._variables.length;r++){var n=document.createElement("th");n.appendChild(document.createTextNode(this._variables[r])),e.appendChild(n),"namedgraph"==this._variables[r]&&(t=!0)}if(t){var n=document.createElement("th");n.appendChild(document.createTextNode(" ")),e.insertBefore(n,e.firstChild)}return e},this._createTableRow=function(e,t){var r=document.createElement("tr");r.className=t%2?"odd":"even";for(var n=null,a=0;a<this._variables.length;a++){var o=this._variables[a];s=document.createElement("td"),s.appendChild(this._formatNode(e[o],o)),r.appendChild(s),"namedgraph"==this._variables[a]&&(n=e[o])}if(n){var i=document.createElement("a");i.href="javascript:snorql.switchToGraph('"+n.value+"')",i.appendChild(document.createTextNode("Switch"));var s=document.createElement("td");s.appendChild(i),r.insertBefore(s,r.firstChild)}return r},this._formatNode=function(e,t){return e?"uri"==e.type?this._formatURI(e,t):"bnode"==e.type?this._formatBlankNode(e,t):"literal"==e.type?this._formatPlainLiteral(e,t):"typed-literal"==e.type?this._formatTypedLiteral(e,t):document.createTextNode("???"):this._formatUnbound(e,t)},this._formatURI=function(e,t){var r=document.createElement("span");r.className="uri";var n=document.createElement("a");n.href=this._getLinkMaker(t)(e.value),n.title="<"+e.value+">",n.className="graph-link";var a=this._toQName(e.value);if(a?(n.appendChild(document.createTextNode(a)),r.appendChild(n)):(match=e.value.match(/\.(png|gif|jpg)(\?.+)?$/),match?(img=document.createElement("img"),img.src=e.value,img.title=e.value,img.className="media",n.appendChild(img),r.appendChild(n)):(n.appendChild(document.createTextNode(e.value)),r.appendChild(document.createTextNode("<")),r.appendChild(n),r.appendChild(document.createTextNode(">")))),match=e.value.match(/^(https?|ftp|mailto|irc|gopher|news):/)){r.appendChild(document.createTextNode(" "));var o=document.createElement("a");o.href=e.value,img=document.createElement("img"),img.src="/img/link.png",img.alt="["+match[1]+"]",img.title="Go to Web page",o.appendChild(img),r.appendChild(o)}return r},this._formatPlainLiteral=function(e){var t='"'+e.value+'"';return e["xml:lang"]&&(t+="@"+e["xml:lang"]),document.createTextNode(t)},this._formatTypedLiteral=function(e){var t='"'+e.value+'"';if(e.datatype&&(t+="^^"+this._toQNameOrURI(e.datatype)),this._isNumericXSDType(e.datatype)){var r=document.createElement("span");return r.title=t,r.appendChild(document.createTextNode(e.value)),r}return document.createTextNode(t)},this._formatBlankNode=function(e){return document.createTextNode("_:"+e.value)},this._formatUnbound=function(){var e=document.createElement("span");return e.className="unbound",e.title="Unbound",e.appendChild(document.createTextNode("-")),e},this._toQName=function(e){for(prefix in this._namespaces){var t=this._namespaces[prefix];if(0==e.indexOf(t))return prefix+":"+e.substring(t.length)}return null},this._toQNameOrURI=function(e){var t=this._toQName(e);return null==t?"<"+e+">":t},this._isNumericXSDType=function(e){for(i=0;i<this._numericXSDTypes.length;i++)if(e==this._xsdNamespace+this._numericXSDTypes[i])return!0;return!1},this._xsdNamespace="http://www.w3.org/2001/XMLSchema#",this._numericXSDTypes=["long","decimal","float","double","int","short","byte","integer","nonPositiveInteger","negativeInteger","nonNegativeInteger","positiveInteger","unsignedLong","unsignedInt","unsignedShort","unsignedByte"]}(this.result,this.prefixes())},new l}]);var app=angular.module("snorql",["ngRoute","ui.codemirror","snorql.service","snorql.ui"]);app.controller("SnorqlCtrl",["$scope","$timeout","$location","snorql",function(e,t,r,n){e.snorql=n,e.outputs=["html","json","csv","xml"],e.output="html",e.message="Excuting query ...",e.waiting=!1,e.filter="",e.cmOption={lineNumbers:!1,indentWithTabs:!0,uiRefresh:!0,mode:"sparql"},e.executeQuery=function(t){e.waiting=!0,e.error=!1,r.search("query",t),r.search("class",null),r.search("property",null),r.search("describe",null);var a=angular.extend(r.search(),{output:e.output});n.executeQuery(t,a).$promise.then(function(){e.waiting=!1},function(t){e.error=t.data,e.waiting=!1})},e.selectExample=function(t){n.query=n.examples[t].query,e.qSelected=t,$("#toggle-examples").click()},e.reset=function(){n.reset()},n.loadExamples(),n.updateQuery(r.search()),e.$on("$locationChangeSuccess",function(){n.updateQuery(r.search())})}]),app.config(["$routeProvider","$locationProvider","$httpProvider",function(e,t,r){r.interceptors.push("errorInterceptor"),e.when("/",{title:"welcome to snorql",templateUrl:"partials/home.html"}),t.html5Mode(!0)}]),app.factory("errorInterceptor",["$q","$rootScope","$location",function(e,t){return{request:function(t){return t||e.when(t)},requestError:function(t){return e.reject(t)},response:function(t){return t||e.when(t)},responseError:function(r){return r&&0===r.status&&(t.error="The API is not accessible"),r&&401===r.status&&(t.error="You are not authorized to access the resource. Please login or review your privileges."),r&&404===r.status&&(t.error="URL not found"),r&&r.status>=500&&(t.error="Request Failed"),e.reject(r)}}}]);